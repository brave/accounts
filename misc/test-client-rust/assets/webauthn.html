<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>WebAuthn</title>
</head>

<body>
    <pre id="status">Starting WebAuthn...</pre>

    <script>
        const statusEl = document.getElementById('status');

        function log(message) {
            statusEl.textContent += '\n' + message;
        }

        async function performRegistration(requestData) {
            log('Prompting user for credential registration...');

            // Parse the JSON options into the format expected by the API
            const options = PublicKeyCredential.parseCreationOptionsFromJSON(requestData.publicKey);

            const credential = await navigator.credentials.create({ publicKey: options });

            if (!credential) {
                throw new Error('No credential returned');
            }

            log('Credential created');
            return credential;
        }

        async function performLogin(requestData) {
            log('Prompting user for authentication...');

            // Parse the JSON options into the format expected by the API
            const options = PublicKeyCredential.parseRequestOptionsFromJSON(requestData.publicKey);

            const credential = await navigator.credentials.get({ publicKey: options });

            if (!credential) {
                throw new Error('No credential returned');
            }

            log('Authentication successful');
            return credential;
        }

        async function performWebAuthn() {
            try {
                log('Fetching request...');

                const initResponse = await fetch('/request');
                if (!initResponse.ok) {
                    throw new Error('Failed to get request');
                }

                const requestData = await initResponse.json();
                const operation = requestData.operation;
                log(`Request received (${operation})`);

                let credential;
                if (operation === 'register') {
                    credential = await performRegistration(requestData.request);
                } else if (operation === 'login') {
                    credential = await performLogin(requestData.request);
                } else {
                    throw new Error('Unknown operation: ' + operation);
                }

                log('Sending credential to server...');

                const finalizeResponse = await fetch('/response', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(credential)
                });

                if (!finalizeResponse.ok) {
                    throw new Error('Failed to send credential');
                }

                log(`WebAuthn ${operation} completed successfully!`);
                window.close();

            } catch (error) {
                log('Error: ' + error.message);
                console.error(error);
            }
        }

        performWebAuthn();
    </script>
</body>

</html>